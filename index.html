<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KNK-Ausgleich (50/50, lineare Reduktion 10 %)</title>
  <style>
    :root{ --bg:#fff; --text:#111; --muted:#555; --border:#d6d6d6; --bstrong:#c6c6c6; --radius:12px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.45}
    .wrap{max-width:960px;margin:32px auto;padding:16px}
    .card{border:1px solid var(--border);border-radius:var(--radius);background:#fff}
    header{padding:18px 20px;border-bottom:1px solid var(--border)}
    h1{margin:0 0 6px;font-size:1.6rem}
    .sub{margin:0;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;padding:18px 20px 6px}
    .field{grid-column:span 6;display:flex;flex-direction:column;gap:6px}
    label{font-weight:600}
    input{padding:10px 12px;border:1px solid var(--bstrong);border-radius:10px;background:#fff;color:#111;font-size:1rem}
    input:focus{outline:2px solid #8edbb6;outline-offset:1px}
    .row{grid-column:span 12;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{border:1px solid var(--bstrong);background:#f5f5f5;padding:10px 14px;border-radius:999px;font-weight:700;cursor:pointer}
    .table-wrap{padding:0 20px 20px}
    table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums lining-nums}
    th,td{border:1px solid var(--border);padding:8px 10px;text-align:right}
    th:first-child, td:first-child{text-align:left}
    thead th{background:#fafafa}
    .muted{color:var(--muted)}
    @media (max-width:820px){.field{grid-column:span 12}.wrap{padding:12px}}
    @media print{
      body{color:#000;background:#fff}
      .card, header, table, th, td{border-color:#000}
      input, button{border-color:#000}
      button{display:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>KNK-Ausgleich bei 50/50-Eigentum</h1>
        <p class="sub">Linear ab Jahr&nbsp;11 wird jährlich <strong>10&nbsp;%</strong> der ursprünglichen Differenz abgezogen; Jahr&nbsp;20 ⇒ 0&nbsp;€.</p>
      </header>

      <form class="grid" onsubmit="event.preventDefault()">
        <div class="field">
          <label for="knk">Kaufnebenkosten gesamt</label>
          <input id="knk" inputmode="decimal" placeholder="z. B. 50.000" />
        </div>
        <div class="field">
          <label for="anteilA">Zahlungsanteil Ehepartner A (%)</label>
          <input id="anteilA" type="number" min="0" max="100" step="0.1" value="30" />
        </div>
        <div class="row">
          <button type="button" id="btnBerechnen">Berechnen</button>
          <button type="button" onclick="window.print()">Drucken…</button>
          <span class="muted">Eigentum: 50 % / 50 % · Abschmelzung: 10 %/Jahr ab Jahr 11</span>
        </div>
      </form>

      <div class="table-wrap">
        <table aria-describedby="desc">
          <caption id="desc" class="muted" style="caption-side:bottom;padding:8px">
            Negative Werte: zu wenig gezahlt (bekommt). Positive Werte: zu viel gezahlt (zahlt).
          </caption>
          <thead>
            <tr>
              <th>Zeile</th>
              <th>Ehepartner A</th>
              <th>Ehepartner B</th>
            </tr>
          </thead>
          <tbody id="tbody"><tr><td colspan="3" class="muted">Bitte Werte eingeben…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

 <script>
  const fmtEUR = new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:2});

  // robuster Parser (unverändert)
  function parseFlexibleNumber(v){
    if(typeof v!=='string') v = String(v ?? '');
    v = v.trim(); if(!v) return NaN;
    v = v.replace(/\s/g,'');
    const hasComma = v.includes(',');
    const dotCount = (v.match(/\./g) || []).length;
    if(hasComma){ v = v.replace(/\./g,'').replace(',', '.'); }
    else if(dotCount){
      if(/^\d{1,3}(\.\d{3})+$/.test(v)){ v = v.replace(/\./g,''); }
      else if(dotCount > 1){ v = v.replace(/\./g,''); }
      else {
        const lastDot = v.lastIndexOf('.'), fracLen = v.length - lastDot - 1;
        const isThousands = fracLen === 3 && /^\d+\.\d{3}$/.test(v);
        if(isThousands) v = v.replace(/\./g,'');
      }
    }
    const n = Number(v);
    return Number.isFinite(n) ? n : NaN;
  }
  const REDUCTION = 0.10;   // 10 % pro Jahr
  const YEARS_START = 11;   // Rückzahlungsplan startet ab Jahr 11
  const YEARS_END   = 20;   // endet in Jahr 20 (0 €)
  const round2 = n => Math.round(n*100)/100;

  function compute(knkTotal, shareApercent){
    const shareA = shareApercent/100, shareB = 1 - shareA;
    const paidA = round2(knkTotal * shareA);
    const paidB = round2(knkTotal * shareB);
    const fair  = round2(knkTotal * 0.5);

    const diffA = round2(paidA - fair);
    const diffB = round2(paidB - fair);

    const decA = round2(diffA * REDUCTION); // 10 % vom Ursprung
    const decB = round2(diffB * REDUCTION);

    // Rückzahlungsplan NUR für Jahre 11..20:
    // Jahr 11: diff - 1*dec, Jahr 12: diff - 2*dec, …, Jahr 20: diff - 10*dec = 0
    const schedule = [];
    for(let year = YEARS_START; year <= YEARS_END; year++){
      const k = year - 10; // 11->1 ... 20->10
      let valA = round2(diffA - decA * k);
      let valB = round2(diffB - decB * k);
      if(Math.sign(valA) !== Math.sign(diffA)) valA = 0;
      if(Math.sign(valB) !== Math.sign(diffB)) valB = 0;
      schedule.push({year, A:valA, B:valB});
    }
    return {paidA, paidB, fair, diffA, diffB, decA, decB, schedule};
  }

  function render(){
    const knk = parseFlexibleNumber(document.getElementById('knk').value);
    const shareA = Number(document.getElementById('anteilA').value);
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    if(!Number.isFinite(knk) || knk<=0 || !Number.isFinite(shareA) || shareA<0 || shareA>100){
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Bitte gültige Werte eingeben.</td></tr>`;
      return;
    }
    const r = compute(knk, shareA);

    addRow('Kaufnebenkosten (100 %)', '—', '—', true);
    addRow('KNK (gezahlt)', fmtEUR.format(r.paidA), fmtEUR.format(r.paidB));
    addRow('KNK 50 %', fmtEUR.format(r.fair), fmtEUR.format(r.fair));
    addRow('Differenz (gezahlt − fair)', fmtSigned(r.diffA), fmtSigned(r.diffB));
    addRow('KNK Rückzahlung 10 % (jährlicher Abbau ab Jahr 11)', fmtSigned(r.decA), fmtSigned(r.decB), true);

    addRow('', '', '', true);
    addRow('Rückzahlungsplan (nur Jahre 11–20)', 'A', 'B', true);
    r.schedule.forEach(s => addRow(`${s.year}. Jahr`, fmtSigned(s.A), fmtSigned(s.B)));

    function addRow(label, a, b, header=false){
      const tr = document.createElement('tr');
      if(header){ tr.style.background='#fafafa'; tr.style.fontWeight='700'; }
      tr.innerHTML = `<td>${label}</td><td>${a}</td><td>${b}</td>`;
      tbody.appendChild(tr);
    }
    function fmtSigned(n){ return (n<0 ? '−' + fmtEUR.format(Math.abs(n)) : fmtEUR.format(n)); }
  }

  document.getElementById('btnBerechnen').addEventListener('click', render);
  ['knk','anteilA'].forEach(id => document.getElementById(id).addEventListener('input', render));
  window.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('knk').value = '50.000';
    document.getElementById('anteilA').value = '30';
    render();
  });
</script>

</body>
</html>
